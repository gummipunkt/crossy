<h1 class="text-xl font-semibold mb-4 flex items-center justify-between gap-3">
  <span>Timeline</span>
  <button onclick="location.reload()" class="inline-flex items-center rounded-md border border-gray-300 bg-white px-2.5 py-2 sm:px-3 hover:bg-gray-50 text-sm">Refresh</button>
</h1>

<script>
  // Auto-Refresh nur auf dieser Seite initialisieren
  window.__timelineInterval && clearInterval(window.__timelineInterval);
  window.__timelineInterval = setInterval(function(){ location.reload() }, 30000);
  document.addEventListener('turbo:before-render', function(){
    // Beim Verlassen der Seite aufräumen
    window.__timelineInterval && clearInterval(window.__timelineInterval);
    window.__timelineInterval = null;
  });
  </script>
  <script>
    async function feedAct(el){
      try{
        const payload = { provider: el.dataset.provider, id: el.dataset.id, action_type: el.dataset.actionType }
        const resp = await fetch('/timeline/action', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
        if(!resp.ok){ alert('Aktion fehlgeschlagen') } else { el.classList.add('opacity-60') }
      }catch(e){ alert('Netzwerkfehler') }
    }
  </script>

<div class="space-y-4">
  <% @items.each do |it| %>
    <div class="rounded-md border bg-white p-4 sm:p-5 shadow-sm">
      <div class="text-sm text-gray-700 flex items-start sm:items-center justify-between gap-2">
        <span class="inline-flex items-center gap-2 flex-wrap">
          <span class="uppercase text-[11px] font-semibold px-2 py-1 rounded-full border
            <%= case it.provider
                when 'mastodon' then 'border-green-300 text-green-700'
                when 'bluesky' then 'border-sky-300 text-sky-700'
                when 'threads' then 'border-purple-300 text-purple-700'
                when 'nostr' then 'border-pink-300 text-pink-700'
                else 'border-gray-300 text-gray-700' end %>">
            <%= it.provider %>
          </span>
          <% if it.author.present? %>
            <span class="text-sm font-medium break-all"><%= it.author %></span>
          <% end %>
        </span>
        <span class="text-xs shrink-0"><% if it.url.present? %><a href="<%= it.url %>" target="_blank" class="text-blue-600 hover:underline"><%= it.created_at&.in_time_zone&.strftime('%Y-%m-%d %H:%M') %></a><% else %><span class="text-gray-500"><%= it.created_at&.in_time_zone&.strftime('%Y-%m-%d %H:%M') %></span><% end %></span>
      </div>
      <div class="mt-3 whitespace-pre-line text-[15px] break-words"><%= it.content %></div>
      <% if it.images.present? %>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <% it.images.first(4).each do |im| %>
            <div class="aspect-square overflow-hidden rounded-md border">
              <img src="<%= im["url"] %>" alt="<%= im["alt"] %>" class="w-full h-full object-cover"/>
            </div>
          <% end %>
        </div>
      <% end %>
      <div class="mt-3 text-sm flex flex-wrap gap-3">
        <% if it.url.present? %>
          <a href="<%= it.url %>" target="_blank" class="text-blue-600 hover:underline">Öffnen</a>
        <% end %>
        <button class="text-gray-700 hover:underline" data-provider="<%= it.provider %>" data-id="<%= it.id %>" data-action-type="like" onclick="feedAct(this)">Like</button>
        <button class="text-gray-700 hover:underline" data-provider="<%= it.provider %>" data-id="<%= it.id %>" data-action-type="repost" onclick="feedAct(this)">Repost</button>
      </div>
    </div>
  <% end %>
</div>


