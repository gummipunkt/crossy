services:
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: crossy
      POSTGRES_PASSWORD: crossy
      POSTGRES_DB: server_development
    volumes:
      - db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U crossy -d server_development"]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  web:
    build: .
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./:/app
      - bundle-data:/usr/local/bundle
    working_dir: /app/server
    environment:
      RAILS_ENV: development
      DATABASE_URL: postgresql://crossy:crossy@db:5432/server_development
      CACHE_DATABASE_URL: postgresql://crossy:crossy@db:5432/server_development_cache
      QUEUE_DATABASE_URL: postgresql://crossy:crossy@db:5432/server_development_queue
      CABLE_DATABASE_URL: postgresql://crossy:crossy@db:5432/server_development_cable
      LOCKBOX_MASTER_KEY: '0000000000000000000000000000000000000000000000000000000000000000'
      BLIND_INDEX_MASTER_KEY: '1111111111111111111111111111111111111111111111111111111111111111'
      REDIS_URL: redis://redis:6379/0
      THREADS_APP_ID: '1173237338204481'
      THREADS_APP_SECRET: 'e5d7d73e2bc3fbfd0a855a196ec93555'
      THREADS_CLIENT_TOKEN: '046abb1154100a94c63697daabed4d61'
      PUBLIC_BASE_URL: 'https://unreconcilable-giana-nonsynoptical.ngrok-free.dev'
    ports:
      - "3000:3000"
    command: bash -lc "bundle install && bin/rails db:prepare && bin/rails server -b 0.0.0.0 -p 3000"

  worker:
    build: .
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      web:
        condition: service_started
    volumes:
      - ./:/app
      - bundle-data:/usr/local/bundle
    working_dir: /app/server
    environment:
      RAILS_ENV: development
      DATABASE_URL: postgresql://crossy:crossy@db:5432/server_development
      CACHE_DATABASE_URL: postgresql://crossy:crossy@db:5432/server_development_cache
      QUEUE_DATABASE_URL: postgresql://crossy:crossy@db:5432/server_development_queue
      CABLE_DATABASE_URL: postgresql://crossy:crossy@db:5432/server_development_cable
      LOCKBOX_MASTER_KEY: '0000000000000000000000000000000000000000000000000000000000000000'
      BLIND_INDEX_MASTER_KEY: '1111111111111111111111111111111111111111111111111111111111111111'
      REDIS_URL: redis://redis:6379/0
      THREADS_APP_ID: '1173237338204481'
      THREADS_APP_SECRET: 'e5d7d73e2bc3fbfd0a855a196ec93555'
      THREADS_CLIENT_TOKEN: '046abb1154100a94c63697daabed4d61'
      PUBLIC_BASE_URL: 'https://unreconcilable-giana-nonsynoptical.ngrok-free.dev'
    command: bash -lc "bundle install && bin/rails db:prepare && bin/rails solid_queue:start"

volumes:
  db-data:
  redis-data:
  bundle-data:


